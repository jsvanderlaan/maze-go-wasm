<html>
    <head>
        <meta charset="utf-8" />
        <script src="wasm_exec.js"></script>
    </head>
    <body>
        <input type="file" id="img" />
        <div id="img-container">
            <img id="source-img" />
            <span id="img-string" style="white-space: pre; font-family: monospace"></span>
        </div>

        <script>
            (async function loadAndRunGoWasm() {
                const go = new Go();
                const result = await WebAssembly.instantiateStreaming(fetch('main.wasm'), go.importObject);
                go.run(result.instance);

                // const blob = await fetchBlob('assets/test.jpg');
                const blob = await fetchBlob('assets/test.png');
                showBlob(blob);

                const img = await getProcessedImage(blob);
                // console.log(img);
                // showText(img);
                showImage(img);
            })();

            const imgInput = document.getElementById('img');
            imgInput.addEventListener('change', async () => {
                const file = imgInput.files[0];
                showBlob(file);

                const img = await getProcessedImage(file);
                // showText(img);
                showImage(img);
            });

            function getProcessedImage(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();

                    reader.onload = event => {
                        const bytes = new Uint8Array(event.target.result);
                        const threshold = 0.9;
                        const height = 100;

                        resolve(processImage(bytes, threshold, height));
                    };

                    // imageType = file.type;
                    reader.readAsArrayBuffer(file);
                });
            }

            function showText(text) {
                document.getElementById('img-string').innerText = text;
            }

            function showImage(buffer) {
                showBlob(new Blob([buffer], { type: 'image/png' } /* (1) */));
            }

            function showBlob(blob) {
                const sourceImg = document.getElementById('source-img');
                sourceImg.src = URL.createObjectURL(blob);
            }

            async function fetchBlob(url) {
                const response = await fetch(url);

                // Here is the significant part
                // reading the stream as a blob instead of json
                return response.blob();
            }
        </script>
    </body>
</html>
